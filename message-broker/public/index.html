<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
        crossorigin="anonymous">
    <title>Document</title>
</head>

<body>
    <div class="container mt-5">
        <h3 class="display-3 mb-5">MESSAGE BROKER DASHBOARD</h3>
        <div class="row">
            <div class="col-4">
                <p class="h3">TOPICS</p>
                <div class="list-group" id="topic-list">
                </div>
                <form id="create-topic" class="mt-3">
                    <div class="input-group mb-3">
                        <input type="text" id="new-topic" class="form-control" placeholder="New topic" aria-label="Recipient's username" aria-describedby="basic-addon2"
                            required>
                        <div class="input-group-append">
                            <button type="submit" class="btn btn-default">+</button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="col-8">
                <p class="h3">SELECTED TOPIC:
                    <span id="selected-topic"></span>
                </p>
                <form class="form-inline" id="sending-message">
                    <input type="text" class="form-control mb-2 mr-sm-2" id="message" placeholder="Type your message" required>
                    <button type="submit" class="btn btn-primary mb-2">ADD MESSAGE</button>
                </form>
                <table class="table">
                    <thead class="thead-dark">
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">Message</th>
                        </tr>
                    </thead>
                    <tbody id="message-list">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>
    <script src="/lib/socket.io-client/dist/socket.io.js"></script>
    <script>
        var topics = []
        var messages = []
        var selectedTopic = ''
        $(document).ready(function () {

            var topicListElement = $('#topic-list')
            var selectedTopicElement = $('#selected-topic')
            var messageListElement = $('#message-list')

            $.get('/topics', function (data, status) {

                if (status === 'success') {

                    topics = data.list
                    if (topics.length <= 0) return
                    reloadTopicList()
                    selectTopicByIndex(0)
                    selectedTopic = topics[0]
                    selectedTopicElement.text(selectedTopic)
                    socket.compress(true).emit('SUBSCRIBE_MULTIPLE_TOPICS', { topics: topics })
                }

            })

            $('#sending-message').on('submit', function (e) {

                e.preventDefault()
                if (selectedTopic === '') return alert('No topic selected')
                const message = $('#message').val()
                $.post('/message', { topic: selectedTopic, message: message }, function (data, status) {

                    if (status === 'success') {
                        alert('Send message successfully!')
                    } else {
                        alert('Send message failed')
                    }

                })

            })

            $('#create-topic').on('submit', function (e) {

                e.preventDefault()
                const newTopic = $('#new-topic').val()
                $.post('/topic', { topic: newTopic }, function (data, status) {

                    if (status === 'success') {
                        topics.push(newTopic)
                        reloadTopicList()
                        socket.compress(true).emit('SUBSCRIBE_TOPIC', { topic: newTopic })
                    } else {
                        alert('Create topic failed')
                    }

                })

            })

            function reloadTopicList() {

                topicListElement.empty()
                topics.forEach((topic, index) => {

                    const topicItem = $('<button />', {
                        "class": 'list-group-item list-group-item-action',
                        text: topic,
                        click: function (e) {
                            selectTopicByIndex(index)
                            selectedTopic = topics[index]
                            selectedTopicElement.text(selectedTopic)
                            reloadMessageList()
                        }
                    })
                    topicListElement.append(topicItem)

                })

            }

            function selectTopicByName(topic) {

                const selectedIndex = topics.findIndex(curTopic => curTopic === topic)
                selectTopicByIndex(selectedIndex)

            }

            function selectTopicByIndex(selectedIndex) {

                topicListElement.find("button").each(index => {

                    if (index === selectedIndex)
                        $(this).addClass("active")
                    else
                        $(this).removeClass("active")

                })

            }

            function reloadMessageList() {

                messageListElement.empty()
                messages.filter(curMessage => curMessage.topic === selectedTopic).forEach((curMessage, index) => {

                    const rowString = `<tr><th scope="row">${index}</th><td>${curMessage.message}</td></tr>`
                    messageListElement.append(rowString)

                })

            }

            var socket = io.connect('http://localhost:8000')
            socket.on('NEW_MESSAGE', function (data) {

                messages.push(data)
                reloadMessageList()

            })

        })
    </script>
</body>

</html>